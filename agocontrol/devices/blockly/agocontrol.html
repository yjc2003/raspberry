<html>
<head>
<script type="text/javascript" src="blockly_uncompressed.js"></script>
<script type="text/javascript" src="blocks/agocontrol.js"></script>
<script type="text/javascript" src="blocks/colour.js"></script>
<script type="text/javascript" src="blocks/lists.js"></script>
<script type="text/javascript" src="blocks/logic.js"></script>
<script type="text/javascript" src="blocks/loops.js"></script>
<script type="text/javascript" src="blocks/math.js"></script>
<script type="text/javascript" src="blocks/procedures.js"></script>
<script type="text/javascript" src="blocks/text.js"></script>
<script type="text/javascript" src="blocks/variables.js"></script>
<script type="text/javascript" src="generators/lua.js"></script>
<script type="text/javascript" src="generators/lua/agocontrol.js"></script>
<script type="text/javascript" src="generators/lua/colour.js"></script>
<script type="text/javascript" src="generators/lua/lists.js"></script>
<script type="text/javascript" src="generators/lua/logic.js"></script>
<script type="text/javascript" src="generators/lua/loops.js"></script>
<script type="text/javascript" src="generators/lua/math.js"></script>
<script type="text/javascript" src="generators/lua/procedures.js"></script>
<script type="text/javascript" src="generators/lua/text.js"></script>
<script type="text/javascript" src="generators/lua/variables.js"></script>
<script type="text/javascript" src="msg/js/en.js"></script>
<script type="text/javascript" src="yaml.min.js"></script>
<script type="text/javascript" src="libphonenumber.js"></script>

</head>
<body>
    <xml id="toolbox" style="display: none">
        <category name="Logic">
            <block type="controls_if"></block>
            <block type="logic_compare"></block>
            <block type="logic_operation"></block>
            <block type="logic_negate"></block>
            <block type="logic_boolean"></block>
            <block type="logic_ternary"></block>
        </category>
        <category name="Loops">
            <block type="controls_repeat"></block>
            <block type="controls_whileUntil"></block>
            <block type="controls_for">
                <value name="FROM">
                    <block type="math_number">
                        <title name="NUM">1</title>
                    </block>
                </value>
                <value name="TO">
                    <block type="math_number">
                        <title name="NUM">10</title>
                    </block>
                </value>
                <value name="BY">
                    <block type="math_number">
                        <title name="NUM">1</title>
                    </block>
                </value>
            </block>
            <block type="controls_forEach"></block>
            <block type="controls_flow_statements"></block>
        </category>
        <category name="Math">
            <block type="math_number"></block>
            <block type="math_arithmetic"></block>
            <block type="math_number_property"></block>
            <block type="agocontrol_range">
                <value name="MIN">
                    <block type="math_number">
                        <title name="NUM">0</title>
                    </block>
                </value>
                <value name="PROP">
                    <block type="agocontrol_eventProperty"></block>
                </value>
                <value name="MAX">
                    <block type="math_number">
                        <title name="NUM">100</title>
                    </block>
                </value>
            </block>
            <block type="math_change">
                <value name="DELTA">
                    <block type="math_number">
                        <title name="NUM">1</title>
                    </block>
                </value>
            </block>
            <block type="math_round"></block>
            <block type="math_on_list"></block>
            <block type="math_constrain">
                <value name="LOW">
                    <block type="math_number">
                        <title name="NUM">1</title>
                    </block>
                </value>
                <value name="HIGH">
                    <block type="math_number">
                        <title name="NUM">100</title>
                    </block>
                </value>
            </block>
            <block type="math_random_int">
                <value name="FROM">
                    <block type="math_number">
                        <title name="NUM">1</title>
                    </block>
                </value>
                <value name="TO">
                    <block type="math_number">
                        <title name="NUM">100</title>
                    </block>
                </value>
            </block>
            <block type="math_random_float"></block>
        </category>
        <category name="Text">
            <block type="text_print"></block>
            <block type="text"></block>
            <block type="agocontrol_email"></block>
            <block type="agocontrol_valueOptions"></block>
            <block type="text_join"></block>
            <block type="text_append">
                <value name="TEXT">
                    <block type="text"></block>
                </value>
            </block>
            <block type="text_length"></block>
            <block type="text_isEmpty"></block>
            <block type="text_indexOf">
                <value name="VALUE">
                    <block type="variables_get">
                        <title name="VAR">mytext</title>
                    </block>
                </value>
            </block>
            <block type="text_charAt">
                <value name="VALUE">
                    <block type="variables_get">
                        <title name="VAR">mytext</title>
                    </block>
                </value>
            </block>
            <block type="text_getSubstring">
                <value name="STRING">
                    <block type="variables_get">
                        <title name="VAR">mytext</title>
                    </block>
                </value>
            </block>
            <block type="text_changeCase"></block>
            <block type="text_trim"></block>
        </category>
        <category name="List">
            <block type="lists_create_empty"></block>
            <block type="lists_create_with"></block>
            <block type="lists_repeat">
                <value name="NUM">
                    <block type="math_number">
                        <field name="NUM">5</field>
                    </block>
                </value>
            </block>
            <block type="lists_length"></block>
            <block type="lists_isEmpty"></block>
            <block type="lists_indexOf">
                <value name="VALUE">
                    <block type="variables_get">
                        <field name="VAR">list</field>
                    </block>
                </value>
            </block>
            <block type="lists_getIndex">
                <value name="VALUE">
                    <block type="variables_get">
                        <field name="VAR">list</field>
                    </block>
                </value>
            </block>
            <block type="lists_setIndex">
                <value name="LIST">
                    <block type="variables_get">
                        <field name="VAR">list</field>
                    </block>
                </value>
            </block>
            <block type="lists_getSublist">
                <value name="LIST">
                    <block type="variables_get">
                        <field name="VAR">list</field>
                    </block>
                </value>
            </block>
        </category>
        <category name="Variables" custom="VARIABLE">
        </category>
        <category name="Procedures" custom="PROCEDURE">
        </category>
        <category name="Agocontrol">
            <category name="Logic">
                <block type="agocontrol_content">
                    <value name="EVENT">
                        <block type="agocontrol_eventAll">
                        </block>
                    </value>
                </block>
                <block type="agocontrol_eventPropertyValue">
                    <value name="PROP">
                        <block type="agocontrol_eventProperty">
                        </block>
                    </value>
                </block>
            </category>
            <category name="Property">
                <block type="agocontrol_time"></block>
                <block type="agocontrol_timeOffset"></block>
                <block type="agocontrol_range"></block>
            </category>
            <category name="Device">
                <block type="agocontrol_device"></block>
                <block type="agocontrol_deviceNo"></block>
                <block type="agocontrol_deviceProperty"></block>
            </category>
            <category name="Event">
                <block type="agocontrol_deviceEvent"></block>
                <block type="agocontrol_eventAll"></block>
                <block type="agocontrol_eventNo"></block>
                <block type="agocontrol_eventProperty"></block>
            </category>
            <category name="Actions">
                <block type="agocontrol_sendMessage"></block>
                <block type="agocontrol_sleep"></block>
            </category>
            <category name="Variables">
                <block type="agocontrol_getVariable"></block>
                <block type="agocontrol_setVariable"></block>
            </category>
        </category>
    </xml>

    <div id="blocklyDiv" style="height: 600px; width: 960px;"></div>
    <button id="generate">generate lua</button>
    <button id="load">load</button>
    <button id="dump">dump</button>
    <button id="allblocks">log all blocks</button>
    <div id="lua" style="height:600px; width:960px;"></div>

  <script type="text/javascript">
    getUnconnectedBlock = function() {
        var blocks = Blockly.mainWorkspace.getAllBlocks();
        for (var i = 0, block; block = blocks[i]; i++)
        {
            var connections = block.getConnections_(true);
            for (var j = 0, conn; conn = connections[j]; j++)
            {
                if (!conn.sourceBlock_ || (conn.type == Blockly.INPUT_VALUE || conn.type == Blockly.OUTPUT_VALUE) && !conn.targetConnection)
                {
                    return block;
                }
            }
        }
        return null;
    };
    
    getBlockWithWarning = function()
    {
        var blocks = Blockly.mainWorkspace.getAllBlocks();
        for (var i = 0, block; block = blocks[i]; i++)
        {
            if (block.warning)
            {
                return block;
            }
        }
        return null;
    };
    
    blinkBlock = function(block)
    {
        for(var i=300; i<3000; i=i+300)
        {
            setTimeout(function() { block.select(); },i);
            setTimeout(function() { block.unselect(); },i+150);
        }
    };
  
    var schema = YAML.load('http://www.agocontrol.com/trac/browser/agocontrol.git/conf/schema.yaml?format=txt');
    var deviceMap = YAML.load('http://192.168.1.1/deviceMap.yaml');
    var variables = YAML.load('http://www.agocontrol.com/trac/browser/agocontrol.git/devices/blockly/variables.yaml?format=txt');
    console.log("schema:");
    console.log(schema);
    console.log("deviceMap:");
    console.log(deviceMap);
    console.log("variables:");
    console.log(variables);
    Blockly.inject(document.getElementById('blocklyDiv'),
        {path: './', toolbox: document.getElementById('toolbox')});
    BlocklyAgocontrol.init(schema, deviceMap, variables);
    var generate = document.getElementById("generate");
    var load = document.getElementById("load");
    var dump = document.getElementById("dump");
    var lua = document.getElementById("lua");
    var allblocks = document.getElementById("allblocks");
    generate.onclick = function() {
    
        // Check for bad block configurations that make it unlikely that
        // the resulting code is correct.
        var badBlock = getUnconnectedBlock();
        if (badBlock)
        {
            warningText = 'This block is not properly connected to other blocks.';
        }
        else
        {
            badBlock = getBlockWithWarning();
            if (badBlock)
            {
                warningText = 'Please fix the warning on this block.';
            }
        }

        if (badBlock)
        {
            lua.innerHTML = '<span style="color:red;">'+warningText+'</span>';
            blinkBlock(badBlock);
            return;
        }
    
        var code = Blockly.Lua.workspaceToCode();
        lua.textContent = code;
    };
    load.onclick = function() {
        //var text = '<xml><block type="controls_if" id="40" inline="false" x="7" y="-88"><value name="IF0"><block type="agocontrol_contentCondition" id="41" inline="true"><value name="EVENT"><block type="agocontrol_eventAll" id="42"><field name="EVENT">event.environment.timechanged</field></block></value></block></value><statement name="DO0"><block type="agocontrol_sendMessage" id="43" inline="false"><value name="COMMAND"><block type="agocontrol_deviceCommand" id="44" inline="false"><mutation currenttype="squeezebox" currentdevice="3fd31990-e51a-47b7-8e40-cd98a12e6af9" currentcommand="displaymessage" duplicated="true"></mutation><field name="TYPE">squeezebox</field><field name="DEVICE">3fd31990-e51a-47b7-8e40-cd98a12e6af9</field><field name="COMMAND">displaymessage</field><value name="CUSTOM_duration"><block type="math_number" id="45"><field name="NUM">5</field></block></value><value name="CUSTOM_line1"><block type="text" id="46"><field name="TEXT">hello</field></block></value><value name="CUSTOM_line2"><block type="text" id="47"><field name="TEXT">world</field></block></value></block></value></block></statement></block></xml>';
        var text = '<xml><block type="controls_if" id="7" inline="false" x="31" y="16"><value name="IF0"><block type="agocontrol_content" id="10" inline="false"><value name="EVENT"><block type="agocontrol_eventAll" id="11"><field name="EVENT">event.dummy.text</field></block></value></block></value><statement name="DO0"><block type="controls_if" id="18" inline="false"><value name="IF0"><block type="logic_compare" id="33" inline="true"><field name="OP">EQ</field><value name="A"><block type="agocontrol_eventProperty" id="60"><field name="EVENT">event.dummy.text</field><field name="PROP">email</field></block></value><value name="B"><block type="math_number" id="55"><field name="NUM">0</field></block></value></block></value></block></statement></block></xml>';
        var xml = Blockly.Xml.textToDom(text);
        Blockly.Xml.domToWorkspace(Blockly.mainWorkspace, xml);
    };
    dump.onclick = function() {
        var dom = Blockly.Xml.workspaceToDom(Blockly.mainWorkspace);
        console.log(dom);
        var xml = Blockly.Xml.domToText(dom);
        console.log(xml);
    };
    allblocks.onclick = function() {
        var all = Blockly.mainWorkspace.getAllBlocks();
        console.log(all);
    };
    var wschanged = function() {
        
    };
  </script>

</body>
</html>
